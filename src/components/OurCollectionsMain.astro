---
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';

const collections = [
  {
    index: '01',
    title: 'Кухня',
    desc: 'Смелые формы и умная эргономика, Кухня с характером, ничего лишнего.',
    img: 'src/assets/images/photo_2024-11-29_17-42-12.jpg',
  },
  {
    index: '02',
    title: 'Urban',
    desc: 'Minimalist designs for city living.',
    img: 'src/assets/images/photo_2022-11-21_10-47-47.jpg',
  },
  {
    index: '04',
    title: 'Life',
    desc: 'Broad-appeal sofas designed with everyday living in mind.',
    img: '/src/assets/images/photo_2024-12-02_15-51-50.jpg',
  },
];
---

<section class="OurCollectionsMain">
  <div class="OurCollectionsMain-bg">
  <img id="bg-image-current" src={collections[0].img} alt="" />
  <img id="bg-image-next" src={collections[0].img} alt="" />
</div>


  <span class="OurCollectionsMain-header">EXPLORE OUR COLLECTIONS</span>

  <div class="OurCollectionsMain-container">
    <div class="OurCollectionsMain-content">
      <div class="OurCollectionsMain-title-group">
        <span class="OurCollectionsMain-index" id="active-index">01</span>
        <div class="OurCollectionsMain-title-group__inner">
          <h2 class="OurCollectionsMain-title" id="active-title">Nest</h2>
          <p class="OurCollectionsMain-description" id="active-desc">
            Elegant comfort for modern spaces.
          </p>
        </div>
      </div>

      <a href="#" class="OurCollectionsMain-cta">
        View collection <span class="OurCollectionsMain-arrow">→</span>
      </a>
    </div>

    <div class="OurCollectionsMain-visual-wrapper">
      <div class="swiper OurCollectionsSwiper">
        <div class="swiper-wrapper">
          {
            collections.map((item) => (
              <div
                class="swiper-slide"
                data-index={item.index}
                data-title={item.title}
                data-desc={item.desc}
              >
                <img
                  src={item.img}
                  alt={item.title}
                  class="OurCollectionsMain-img"
                />
              </div>
            ))
          }
        </div>
      </div>

      <div class="OurCollectionsMain-controls">
        <div class="swiper-navigation-group">
          <button class="swiper-prev">←</button>
          <button class="swiper-next">→</button>
        </div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </div>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, EffectFade } from 'swiper/modules';

  const swiper = new Swiper('.OurCollectionsSwiper', {
    modules: [Navigation, Pagination, EffectFade],
    loop: true,
    speed: 800,
    effect: 'fade',
    fadeEffect: {
      crossFade: true,
    },
    navigation: {
      nextEl: '.swiper-next',
      prevEl: '.swiper-prev',
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
    },
    on: {
  slideChange: (swiper) => {
    const activeSlide = swiper.slides[swiper.activeIndex];
    const contentWrapper = document.querySelector('.OurCollectionsMain-content') as HTMLElement;
    const bgCurrent = document.getElementById('bg-image-current') as HTMLImageElement;
    const bgNext = document.getElementById('bg-image-next') as HTMLImageElement;

    if (!contentWrapper || !bgCurrent || !bgNext || !activeSlide) return;

    // 1. Prepare next bg image (preload)
    const nextImg = activeSlide.querySelector('.OurCollectionsMain-img')?.getAttribute('src');
    if (!nextImg) return;
    bgNext.src = nextImg;

    // 2. Fade out both content and current bg
    contentWrapper.style.opacity = '0';
    bgCurrent.style.opacity = '0';

    // 3. Force reflow (ensures smooth CSS transition)
    void bgNext.offsetWidth;

    // 4. Fade in content and next bg **at the same time**
    contentWrapper.style.opacity = '1';
    bgNext.style.opacity = '1';

    // 5. Update content immediately while opacity is 0
    const titleEl = document.getElementById('active-title');
    const indexEl = document.getElementById('active-index');
    const descEl = document.getElementById('active-desc');

    if (titleEl) titleEl.textContent = activeSlide.getAttribute('data-title');
    if (indexEl) indexEl.textContent = activeSlide.getAttribute('data-index');
    if (descEl) descEl.textContent = activeSlide.getAttribute('data-desc');

    // 6. Swap layers after transition duration
    setTimeout(() => {
      bgCurrent.src = bgNext.src;
      bgCurrent.style.opacity = '1';
      bgNext.style.opacity = '0';
    }, 800); // match CSS transition duration
  },
}

  });
</script>

---
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';

const collections = [
  {
    index: '01',
    title: 'Кухня',
    desc: 'Смелые формы и умная эргономика, Кухня с характером, ничего лишнего.',
    img: 'src/assets/images/photo_2024-11-29_17-42-12.jpg',
  },
  {
    index: '02',
    title: 'Urban',
    desc: 'Minimalist designs for city living.',
    img: 'src/assets/images/photo_2022-11-21_10-47-47.jpg',
  },
  {
    index: '04',
    title: 'Life',
    desc: 'Broad-appeal sofas designed with everyday living in mind.',
    img: '/src/assets/images/photo_2024-12-02_15-51-50.jpg',
  },
];
---

<section class="OurCollectionsMain">
  <div class="OurCollectionsMain-bg">
    <img id="bg-image-current" src={collections[0].img} alt="" />
    <img id="bg-image-next" src={collections[0].img} alt="" />
  </div>

  <span class="OurCollectionsMain-header">EXPLORE OUR COLLECTIONS</span>

  <div class="OurCollectionsMain-container">
    <div class="OurCollectionsMain-content">
      <div class="content-layer layer-1 active">
        <div class="OurCollectionsMain-title-group">
          <span class="OurCollectionsMain-index">01</span>
          <div class="OurCollectionsMain-title-group__inner">
            <h2 class="OurCollectionsMain-title">Nest</h2>
            <p class="OurCollectionsMain-description">
              Elegant comfort for modern spaces.
            </p>
          </div>
        </div>
      </div>

      <div class="content-layer layer-2">
        <div class="OurCollectionsMain-title-group">
          <span class="OurCollectionsMain-index"></span>
          <div class="OurCollectionsMain-title-group__inner">
            <h2 class="OurCollectionsMain-title"></h2>
            <p class="OurCollectionsMain-description"></p>
          </div>
        </div>
      </div>

      <a href="#" class="OurCollectionsMain-cta">
        View collection <span class="OurCollectionsMain-arrow">→</span>
      </a>
    </div>

    <div class="OurCollectionsMain-visual-wrapper">
      <div class="swiper OurCollectionsSwiper">
        <div class="swiper-wrapper">
          {
            collections.map((item) => (
              <div
                class="swiper-slide"
                data-index={item.index}
                data-title={item.title}
                data-desc={item.desc}
              >
                <img
                  src={item.img}
                  alt={item.title}
                  class="OurCollectionsMain-img"
                />
              </div>
            ))
          }
        </div>
      </div>

      <div class="OurCollectionsMain-controls">
        <div class="swiper-navigation-group">
          <button class="swiper-prev" aria-label="Previous slide">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 45 10"
            >
              <path stroke-width="1" d="M0 5h44m0 0-4-4m4 4-4 4"></path>
            </svg>
          </button>
          <button class="swiper-next" aria-label="Next slide">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 45 10"
            >
              <path stroke-width="1" d="M0 5h44m0 0-4-4m4 4-4 4"></path>
            </svg>
          </button>
        </div>

        <div class="swiper-progress-bar">
          <div class="swiper-progress-fill"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, EffectFade } from 'swiper/modules';

  // Initialize Swiper
  const swiper = new Swiper('.OurCollectionsSwiper', {
    modules: [Navigation, Pagination, EffectFade],
    loop: false, // No looping
    speed: 800,
    effect: 'fade',
    fadeEffect: {
      crossFade: true,
    },
    navigation: {
      nextEl: '.swiper-next',
      prevEl: '.swiper-prev',
    },
    pagination: {
      el: '.swiper-pagination', // optional, can remove if using custom progress
      clickable: true,
    },
  });

  // Select progress fill element
  const progressFill = document.querySelector(
    '.swiper-progress-fill'
  ) as HTMLElement;

  // Slide change event
  swiper.on('slideChange', () => {
    const totalSlides = swiper.slides.length;
    const currentIndex = swiper.activeIndex + 1; // +1 because index starts at 0

    // Update progress fill width
    if (progressFill) {
      const percentage = (currentIndex / totalSlides) * 100;
      progressFill.style.width = `${percentage}%`;
    }

    // Update background images
    const activeSlide = swiper.slides[swiper.activeIndex];
    if (!activeSlide) return;

    const nextImgSrc = activeSlide
      .querySelector('.OurCollectionsMain-img')
      ?.getAttribute('src');
    const bgCurrent = document.getElementById(
      'bg-image-current'
    ) as HTMLImageElement | null;
    const bgNext = document.getElementById(
      'bg-image-next'
    ) as HTMLImageElement | null;

    if (bgCurrent && bgNext && nextImgSrc) {
      if (bgCurrent.src.includes(nextImgSrc)) return;

      bgNext.src = nextImgSrc;
      bgCurrent.style.opacity = '0';
      bgNext.style.opacity = '1';

      // Sync after transition
      setTimeout(() => {
        bgCurrent.src = nextImgSrc;
        bgCurrent.style.opacity = '1';
        bgNext.style.opacity = '0';
      }, 250);
    }

    // Update text content
    const layers = document.querySelectorAll('.content-layer');
    const outgoingLayer = document.querySelector(
      '.content-layer.active'
    ) as HTMLElement | null;
    const incomingLayer = Array.from(layers).find(
      (l) => l !== outgoingLayer
    ) as HTMLElement | null;

    if (incomingLayer && outgoingLayer) {
      const title = activeSlide.getAttribute('data-title') ?? '';
      const index = activeSlide.getAttribute('data-index') ?? '';
      const desc = activeSlide.getAttribute('data-desc') ?? '';

      const titleEl = incomingLayer.querySelector('.OurCollectionsMain-title');
      const indexEl = incomingLayer.querySelector('.OurCollectionsMain-index');
      const descEl = incomingLayer.querySelector(
        '.OurCollectionsMain-description'
      );

      if (titleEl) titleEl.textContent = title;
      if (indexEl) indexEl.textContent = index;
      if (descEl) descEl.textContent = desc;

      outgoingLayer.classList.remove('active');
      incomingLayer.classList.add('active');
    }

    // Disable prev/next buttons if at edges
    const prevBtn = document.querySelector(
      '.swiper-prev'
    ) as HTMLButtonElement | null;
    const nextBtn = document.querySelector(
      '.swiper-next'
    ) as HTMLButtonElement | null;

    if (prevBtn) prevBtn.disabled = swiper.isBeginning;
    if (nextBtn) nextBtn.disabled = swiper.isEnd;
  });

  // Initialize progress fill on page load
  if (progressFill) {
    const totalSlides = swiper.slides.length;
    const initialPercentage = ((swiper.activeIndex + 1) / totalSlides) * 100;
    progressFill.style.width = `${initialPercentage}%`;
  }
</script>

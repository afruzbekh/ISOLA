---
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';

const collections = [
  {
    index: '01',
    title: 'Кухня',
    desc: 'Смелые формы и умная эргономика, Кухня с характером, ничего лишнего.',
    img: 'src/assets/images/photo_2024-11-29_17-42-12.jpg',
  },
  {
    index: '02',
    title: 'Urban',
    desc: 'Minimalist designs for city living.',
    img: 'src/assets/images/photo_2022-11-21_10-47-47.jpg',
  },
  {
    index: '04',
    title: 'Life',
    desc: 'Broad-appeal sofas designed with everyday living in mind.',
    img: '/src/assets/images/photo_2024-12-02_15-51-50.jpg',
  },
];
---

<section class="OurCollectionsMain">
  <div class="OurCollectionsMain-bg">
    <img id="bg-image-current" src={collections[0].img} alt="" />
    <img id="bg-image-next" src={collections[0].img} alt="" />
  </div>

  <span class="OurCollectionsMain-header">EXPLORE OUR COLLECTIONS</span>

  <div class="OurCollectionsMain-container">
    <div class="OurCollectionsMain-content">
      <div class="content-layer layer-1 active">
        <div class="OurCollectionsMain-title-group">
          <span class="OurCollectionsMain-index">01</span>
          <div class="OurCollectionsMain-title-group__inner">
            <h2 class="OurCollectionsMain-title">Nest</h2>
            <p class="OurCollectionsMain-description">
              Elegant comfort for modern spaces.
            </p>
          </div>
        </div>
      </div>

      <div class="content-layer layer-2">
        <div class="OurCollectionsMain-title-group">
          <span class="OurCollectionsMain-index"></span>
          <div class="OurCollectionsMain-title-group__inner">
            <h2 class="OurCollectionsMain-title"></h2>
            <p class="OurCollectionsMain-description"></p>
          </div>
        </div>
      </div>

      <a href="#" class="OurCollectionsMain-cta">
        View collection <span class="OurCollectionsMain-arrow">→</span>
      </a>
    </div>

    <div class="OurCollectionsMain-visual-wrapper">
      <div class="swiper OurCollectionsSwiper">
        <div class="swiper-wrapper">
          {
            collections.map((item) => (
              <div
                class="swiper-slide"
                data-index={item.index}
                data-title={item.title}
                data-desc={item.desc}
              >
                <img
                  src={item.img}
                  alt={item.title}
                  class="OurCollectionsMain-img"
                />
              </div>
            ))
          }
        </div>
      </div>

      <div class="OurCollectionsMain-controls">
        <div class="swiper-navigation-group">
          <button class="swiper-prev">←</button>
          <button class="swiper-next">→</button>
        </div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </div>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, EffectFade } from 'swiper/modules';

  const swiper = new Swiper('.OurCollectionsSwiper', {
    modules: [Navigation, Pagination, EffectFade],
    loop: false, // Stopped looping as requested
    speed: 800,
    effect: 'fade',
    fadeEffect: {
      crossFade: true,
    },
    navigation: {
      nextEl: '.swiper-next',
      prevEl: '.swiper-prev',
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
    },
    on: {
      slideChange: (swiper) => {
        // 1. Get the current active slide element
        const activeSlide = swiper.slides[swiper.activeIndex];
        if (!activeSlide) return;

        // 2. Extract data directly from the HTML attributes of the slide
        // This avoids needing the 'collections' variable in the script
        const title = activeSlide.getAttribute('data-title') ?? '';
        const index = activeSlide.getAttribute('data-index') ?? '';
        const desc = activeSlide.getAttribute('data-desc') ?? '';
        const nextImgSrc = activeSlide.querySelector('.OurCollectionsMain-img')?.getAttribute('src');

        // 3. Select UI Elements
        const bgCurrent = document.getElementById('bg-image-current') as HTMLImageElement | null;
        const bgNext = document.getElementById('bg-image-next') as HTMLImageElement | null;
        
        const layers = document.querySelectorAll('.content-layer');
        const outgoingLayer = document.querySelector('.content-layer.active') as HTMLElement | null;
        const incomingLayer = Array.from(layers).find(l => l !== outgoingLayer) as HTMLElement | null;

        // 4. Handle Text Cross-Fade
        if (incomingLayer && outgoingLayer) {
          const titleEl = incomingLayer.querySelector('.OurCollectionsMain-title');
          const indexEl = incomingLayer.querySelector('.OurCollectionsMain-index');
          const descEl = incomingLayer.querySelector('.OurCollectionsMain-description');

          if (titleEl) titleEl.textContent = title;
          if (indexEl) indexEl.textContent = index;
          if (descEl) descEl.textContent = desc;

          // CSS classes handle the opacity transition
          outgoingLayer.classList.remove('active');
          incomingLayer.classList.add('active');
        }

        // 5. Handle Background Cross-Fade
        if (bgCurrent && bgNext && nextImgSrc) {
          // Prevent transition if the image hasn't changed
          if (bgCurrent.src.includes(nextImgSrc)) return;

          bgNext.src = nextImgSrc;
          
          bgCurrent.style.opacity = '0';
          bgNext.style.opacity = '1';

          // Cleanup: Sync the images after the transition finishes
          setTimeout(() => {
            bgCurrent.src = nextImgSrc;
            bgCurrent.style.opacity = '1';
            bgNext.style.opacity = '0';
          }, 250); 
        }
      },
    },
  });
</script>
